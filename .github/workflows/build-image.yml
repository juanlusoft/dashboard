name: Build HomePiNAS Image

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 2.6.0)'
        required: false
        default: ''

env:
  RPI_IMAGE_URL: https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-2024-11-19/2024-11-19-raspios-bookworm-arm64-lite.img.xz
  RPI_IMAGE_NAME: 2024-11-19-raspios-bookworm-arm64-lite

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION=$(grep '"version"' package.json | head -1 | sed 's/.*: "\(.*\)".*/\1/')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xz-utils parted fdisk kpartx qemu-user-static

      - name: Download Raspberry Pi OS
        run: |
          echo "Downloading Raspberry Pi OS Lite (arm64)..."
          wget -q --show-progress "$RPI_IMAGE_URL" -O "${RPI_IMAGE_NAME}.img.xz"
          echo "Extracting..."
          xz -d "${RPI_IMAGE_NAME}.img.xz"
          ls -lh "${RPI_IMAGE_NAME}.img"

      - name: Customize image
        run: |
          chmod +x image-builder/customize-image.sh
          sudo ./image-builder/customize-image.sh "${RPI_IMAGE_NAME}.img"
          
          # Find the output image
          OUTPUT_IMG=$(ls -1 *-homepinas-*.img 2>/dev/null | head -1)
          echo "OUTPUT_IMG=$OUTPUT_IMG" >> $GITHUB_ENV
          ls -lh "$OUTPUT_IMG"

      - name: Compress image
        run: |
          echo "Compressing image..."
          xz -9 -T0 "$OUTPUT_IMG"
          COMPRESSED="${OUTPUT_IMG}.xz"
          echo "COMPRESSED=$COMPRESSED" >> $GITHUB_ENV
          ls -lh "$COMPRESSED"
          
          # Calculate checksum
          sha256sum "$COMPRESSED" > "${COMPRESSED}.sha256"
          cat "${COMPRESSED}.sha256"

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          name: HomePiNAS v${{ steps.version.outputs.version }}
          body: |
            ## HomePiNAS v${{ steps.version.outputs.version }}
            
            ### ðŸ“¥ InstalaciÃ³n
            
            1. Descarga el archivo `.img.xz`
            2. Flashea con [Raspberry Pi Imager](https://www.raspberrypi.com/software/) o [balenaEtcher](https://etcher.balena.io/)
            3. Inserta la SD/USB en tu Raspberry Pi y enciende
            4. Sigue el asistente de configuraciÃ³n en pantalla
            5. El dashboard se instalarÃ¡ automÃ¡ticamente
            
            ### ðŸ”— Acceso
            
            Una vez instalado, accede a: `https://homepinas.local` o `https://<IP>`
            
            ### ðŸ“‹ Requisitos
            
            - Raspberry Pi 4 / Pi 5 / CM4 / CM5
            - SD Card o USB de 8GB+ 
            - ConexiÃ³n a internet (para descarga del dashboard)
            
            ### âœ… Verificar integridad
            
            ```bash
            sha256sum -c ${{ env.COMPRESSED }}.sha256
            ```
          files: |
            ${{ env.COMPRESSED }}
            ${{ env.COMPRESSED }}.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact (non-release builds)
        if: "!startsWith(github.ref, 'refs/tags/')"
        uses: actions/upload-artifact@v4
        with:
          name: homepinas-image-v${{ steps.version.outputs.version }}
          path: |
            ${{ env.COMPRESSED }}
            ${{ env.COMPRESSED }}.sha256
          retention-days: 7
